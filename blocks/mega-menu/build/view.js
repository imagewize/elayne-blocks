import{getContext as e,getElement as n,store as t}from"@wordpress/interactivity";const{state:s,actions:o}=t("elayne/mega-menu",{state:{get isMenuOpen(){return e().isOpen||!1},get isMobile(){return window.innerWidth<768}},actions:{toggleMenu(){e().isOpen?o.closeMenu():o.openMenu()},toggleMenuOnClick(){const t=e(),{ref:s}=n();t.menuOpenedBy.click||t.menuOpenedBy.focus?o.closeMenu():(t.previousFocus=s,o.openMenu("click"))},closeMenuOnClick(){o.closeMenu("click"),o.closeMenu("focus")},handleMenuKeydown(n){const t=e();if("Escape"===n?.key&&t.isOpen&&(o.closeMenu(),n.preventDefault()),"Tab"===n?.key&&t.isOpen){const{layoutMode:e}=t;if("overlay"===e||"sidebar"===e){const{firstFocusable:e,lastFocusable:s}=t;n.shiftKey&&document.activeElement===e?(n.preventDefault(),s?.focus()):n.shiftKey||document.activeElement!==s||(n.preventDefault(),e?.focus())}}t.menuOpenedBy?.click&&"Escape"===n?.key&&o.closeMenuOnClick()},handleOutsideClick(t){const s=e(),{ref:i}=n();if(!s.isOpen)return;i.contains(t.target)||o.closeMenu();const a=s?.megaMenu;a&&!a.contains(t.target)&&o.closeMenuOnClick()},openMenu(t="click"){const i=e(),{ref:a}=n(),{layoutMode:l,dropdownAlignment:c}=i;switch(l){case"dropdown":if("auto"===c){const e=a.querySelector(".wp-block-elayne-mega-menu__panel");if(e){e.style.visibility="hidden",e.style.opacity="0",e.classList.add("is-open");const{flipHorizontal:n,nudgeLeft:t}=function(e,n){if("auto"!==n)return{};const t=e.getBoundingClientRect(),s=window.innerWidth,o=t.right-s;return o>100?{flipHorizontal:!0,nudgeLeft:0}:o>0?{flipHorizontal:!1,nudgeLeft:o+20}:{flipHorizontal:!1,nudgeLeft:0}}(e,c);n?(e.classList.add("flip-horizontal"),e.style.left="",e.style.right="0"):t>0?(e.classList.remove("flip-horizontal"),e.style.left=`-${t}px`,e.style.right=""):(e.classList.remove("flip-horizontal"),e.style.left="",e.style.right=""),e.style.visibility="",e.style.opacity="",e.classList.remove("is-open")}}break;case"overlay":document.body.classList.add("mega-menu-overlay-open");break;case"sidebar":document.body.classList.add("mega-menu-sidebar-open"),s.isMobile&&o.initSwipeHandler()}i.isOpen=!0,t&&i.menuOpenedBy&&(i.menuOpenedBy[t]=!0),i.animationSpeed&&a.style.setProperty("--mm-animation-speed",`${i.animationSpeed}ms`),o.setFocusTrap()},openOverlay(){document.body.classList.add("mega-menu-overlay-open")},openSidebar(){document.body.classList.add("mega-menu-sidebar-open"),s.isMobile&&o.initSwipeHandler()},openDropdown(){},openGrid(){},closeMenu(t="click"){const s=e(),{ref:i}=n(),{layoutMode:a}=s;switch(s.isOpen=!1,t&&s.menuOpenedBy&&(s.menuOpenedBy[t]=!1),a){case"dropdown":const e=i.querySelector(".wp-block-elayne-mega-menu__panel");e&&(e.classList.remove("flip-horizontal"),e.style.left="",e.style.right="");break;case"overlay":document.body.classList.remove("mega-menu-overlay-open");break;case"sidebar":document.body.classList.remove("mega-menu-sidebar-open")}o.returnFocus()},setFocusTrap(){const t=e(),{ref:s}=n(),o=s.querySelector(".wp-block-elayne-mega-menu__panel");if(!o)return;const i=o.querySelectorAll('a[href], button, input, textarea, select, [tabindex]:not([tabindex="-1"])');t.firstFocusable=i[0],t.lastFocusable=i[i.length-1],setTimeout(()=>{t.firstFocusable?.focus()},100)},returnFocus(){const{ref:e}=n(),t=e.querySelector(".wp-block-elayne-mega-menu__trigger");t?.focus()},initSwipeHandler(){const t=e(),{ref:s}=n();let i=0,a=0;const l=s.querySelector(".elayne-mega-menu, .wp-block-elayne-mega-menu__menu-container");l&&(l.addEventListener("touchstart",e=>{i=e.touches[0].clientX},{passive:!0}),l.addEventListener("touchend",e=>{a=e.changedTouches[0].clientX,(()=>{const e=a-i;if(Math.abs(e)>50){const{sidebarDirection:n}=t;("left"===n&&e<0||"right"===n&&e>0)&&o.closeMenuOnClick()}})()},{passive:!0}))},updateMobileState(){const n=e(),t=n.mobileBreakpoint||768;n.isMobile=window.innerWidth<t}},callbacks:{initMenu(){const t=e(),{ref:i}=n();s.isMenuOpen&&(t.megaMenu=i),o.updateMobileState(),t.resizeListenerAdded||(window.addEventListener("resize",o.updateMobileState),t.resizeListenerAdded=!0)}}});